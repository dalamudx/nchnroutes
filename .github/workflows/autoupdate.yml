#############################################################################
#                                                                           #
#                     NCHNROUTES è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ                              #
#                                                                           #
#############################################################################

name: Auto-generate and upload routes

# è§¦å‘æ¡ä»¶é…ç½®
# -----------------------------------------------------------------------------
on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: "0 2 * * *"

  # ä»“åº“äº’åŠ¨è§¦å‘ - å½“æœ‰äººå¯¹ä»“åº“æ ‡æ˜Ÿæ—¶è§¦å‘
  watch:
    types: [started]

  # ä»£ç å˜æ›´è§¦å‘ - å½“ä¸»åˆ†æ”¯å…³é”®æ–‡ä»¶æœ‰å˜æ›´æ—¶è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - 'produce.py'    # è·¯ç”±ç”Ÿæˆè„šæœ¬
      - 'Makefile'      # æ„å»ºé…ç½®

  # æ‰‹åŠ¨è§¦å‘ - å…è®¸é€šè¿‡GitHub Actionsç•Œé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ä»»åŠ¡é…ç½®
# -----------------------------------------------------------------------------
jobs:
  # ä¸»æ„å»ºä»»åŠ¡
  # ---------------------------------------------------------------------------
  build:
    name: ğŸ“¦ Build and Publish Routes
    runs-on: ubuntu-22.04

    steps:
    # ç¬¬ä¸€é˜¶æ®µ: ç¯å¢ƒå‡†å¤‡
    # -------------------------------------------------------------------------
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 1  # åªè·å–æœ€æ–°çš„æäº¤ï¼ŒåŠ å¿«å…‹éš†é€Ÿåº¦

    - name: ğŸ’¾ Cache IP Lists
      uses: actions/cache@v3
      id: cache-ip-lists
      with:
        # ç¼“å­˜IPåˆ—è¡¨æ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸‹è½½
        path: |
          delegated-apnic-latest
          china_ip_list.txt
          ipv4-address-space.csv
        key: ${{ runner.os }}-ip-lists-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-ip-lists-

    - name: ğŸ” Validate Environment
      run: |
        # æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®
        if [ -z "$PASS_IPS" ]; then
          echo "âš ï¸ Warning: PASS_IPS environment variable is not set. No IPs will be excluded."
        else
          echo "âœ… PASS_IPS is set. IPs will be excluded according to configuration."
        fi

        # å®‰è£…BIRDä»¥è¿›è¡Œè¯­æ³•æ£€æŸ¥
        sudo apt install bird2 -y

        # æ˜¾ç¤ºPythonç‰ˆæœ¬
        echo "ğŸ Python version:"
        python3 --version

      env:
        PASS_IPS: ${{ secrets.PASS_IPS }}

    # ç¬¬äºŒé˜¶æ®µ: æ„å»ºè·¯ç”±è¡¨
    # -------------------------------------------------------------------------
    - name: ğŸ”¨ Build nchnroutes
      id: build
      env:
        PASS_IPS: ${{ secrets.PASS_IPS }}
      run: |
        echo "ğŸš€ Starting build process..."

        # æ·»åŠ é‡è¯•æœºåˆ¶ï¼Œæé«˜æ„å»ºå¯é æ€§
        max_retries=3
        retry_count=0

        while [ $retry_count -lt $max_retries ]; do
          echo "ğŸ”„ Build attempt $(($retry_count+1))/$max_retries"

          if make; then
            echo "âœ… Build successful!"
            break
          else
            retry_count=$((retry_count+1))
            if [ $retry_count -lt $max_retries ]; then
              echo "âš ï¸ Build failed, retrying ($retry_count/$max_retries)..."
              sleep 10
            else
              echo "âŒ Build failed after $max_retries attempts."
              exit 1
            fi
          fi
        done

        # è®°å½•è·¯ç”±æ¡ç›®æ•°é‡å’Œæ„å»ºæ—¶é—´ï¼Œç”¨äºåç»­æ­¥éª¤
        echo "ğŸ“Š Counting routes..."
        IPV4_COUNT=$(grep -c "route" routes4.conf || echo "0")
        IPV6_COUNT=$(grep -c "route" routes6.conf || echo "0")
        echo "ğŸ“ˆ IPv4 Routes: $IPV4_COUNT"
        echo "ğŸ“ˆ IPv6 Routes: $IPV6_COUNT"

        # è¾“å‡ºåˆ°GitHub Actionsç¯å¢ƒå˜é‡
        echo "ipv4_count=$IPV4_COUNT" >> $GITHUB_OUTPUT
        echo "ipv6_count=$IPV6_COUNT" >> $GITHUB_OUTPUT
        echo "build_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "build_time=$(date +'%H-%M-%S')" >> $GITHUB_OUTPUT

    # ç¬¬ä¸‰é˜¶æ®µ: éªŒè¯ç”Ÿæˆçš„è·¯ç”±è¡¨
    # -------------------------------------------------------------------------
    - name: ğŸ” Validate Generated Routes
      id: validate
      run: |
        echo "ğŸ§ª Starting validation process..."

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "routes4.conf" ] || [ ! -f "routes6.conf" ]; then
          echo "âŒ Error: Route files not generated!"
          exit 1
        fi

        # æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦åˆç†
        IPV4_COUNT=${{ steps.build.outputs.ipv4_count }}
        IPV6_COUNT=${{ steps.build.outputs.ipv6_count }}

        echo "ğŸ“Š IPv4 routes count: $IPV4_COUNT"
        echo "ğŸ“Š IPv6 routes count: $IPV6_COUNT"

        # åˆå§‹åŒ–è­¦å‘Šä¿¡æ¯å˜é‡
        WARNINGS=""

        # å…è®¸æœ‰10%çš„æµ®åŠ¨èŒƒå›´
        if [ $IPV4_COUNT -lt 9900 ] || [ $IPV4_COUNT -gt 15000 ]; then
          WARNING_MSG="âš ï¸ Warning: IPv4 routes count ($IPV4_COUNT) is outside the expected range (9900-13200)"
          echo "$WARNING_MSG"
          WARNINGS="${WARNINGS}${WARNING_MSG}\n"
        fi

        if [ $IPV6_COUNT -lt 12600 ] || [ $IPV6_COUNT -gt 16000 ]; then
          WARNING_MSG="âš ï¸ Warning: IPv6 routes count ($IPV6_COUNT) is outside the expected range (12600-15400)"
          echo "$WARNING_MSG"
          WARNINGS="${WARNINGS}${WARNING_MSG}\n"
        fi

        # æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®
        echo "ğŸ” Checking route format..."
        if ! grep -q "route .* via \".*\";" routes4.conf; then
          echo "âŒ Error: IPv4 routes format is incorrect!"
          exit 1
        fi

        if ! grep -q "route .* via \".*\";" routes6.conf; then
          echo "âŒ Error: IPv6 routes format is incorrect!"
          exit 1
        fi
        # å°è¯•ä½¿ç”¨BIRDè¯­æ³•æ£€æŸ¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if command -v bird >/dev/null 2>&1; then
          echo "ğŸ” Performing BIRD syntax check..."
          if ! bird -c test.conf -p; then
            WARNING_MSG="âš ï¸ Warning: BIRD syntax check failed for routes"
            echo "$WARNING_MSG"
            WARNINGS="${WARNINGS}${WARNING_MSG}\n"
          fi
        else
          echo "â„¹ï¸ BIRD not available, skipping syntax check"
        fi

        # è®°å½•æ€§èƒ½æŒ‡æ ‡
        echo "â±ï¸ Measuring performance..."
        START_TIME=$(date +%s)
        wc -l routes4.conf routes6.conf
        END_TIME=$(date +%s)
        ELAPSED=$((END_TIME - START_TIME))
        echo "â±ï¸ Performance: Processed $(($IPV4_COUNT + $IPV6_COUNT)) routes in ${ELAPSED} seconds"

        # è¾“å‡ºè­¦å‘Šä¿¡æ¯ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "warnings<<EOF" >> $GITHUB_OUTPUT
        echo -e "$WARNINGS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "âœ… Routes validation completed!"

    # ç¬¬å››é˜¶æ®µ: åˆ›å»ºå‘å¸ƒå†…å®¹
    # -------------------------------------------------------------------------
    - name: ğŸ“ Create Release Notes
      run: |
        echo "ğŸ“‹ Creating release notes..."
        cat > release_notes.md << EOF
        # ğŸŒ nchnroutes Latest Routes

        This is the latest update of the nchnroutes configuration.

        ## ğŸ“Š Statistics
        - IPv4 Routes: ${{ steps.build.outputs.ipv4_count }} entries
        - IPv6 Routes: ${{ steps.build.outputs.ipv6_count }} entries
        - Build Date: ${{ steps.build.outputs.build_date }}
        - Build Time: ${{ steps.build.outputs.build_time }}

        ## ğŸ“ Files
        - routes4.conf: IPv4 routes in BIRD format
        - routes6.conf: IPv6 routes in BIRD format

        ## âš ï¸ Warnings
        ${{ steps.validate.outputs.warnings }}

        ## ğŸ“š Usage
        For usage instructions, please refer to the [README](https://github.com/${{ github.repository }}/blob/main/README.md).
        EOF

        echo "âœ… Release notes created!"

    # ç¬¬äº”é˜¶æ®µ: å‘å¸ƒè·¯ç”±è¡¨
    # -------------------------------------------------------------------------
    - name: ğŸ“¤ Upload to Latest Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # åªæ›´æ–°latestæ ‡ç­¾ï¼Œæ–¹ä¾¿ç”¨æˆ·è·å–æœ€æ–°ç‰ˆæœ¬
        tag_name: latest
        name: "latest"
        body_path: release_notes.md
        files: |
          ./routes4.conf
          ./routes6.conf
        draft: false
        prerelease: false


  # æ¸…ç†ä»»åŠ¡
  # ---------------------------------------------------------------------------
  del_runs:
    name: ğŸ§¹ Clean Up Workflow Runs
    needs: build  # åªæœ‰åœ¨buildæˆåŠŸåæ‰æ‰§è¡Œ
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: ğŸ—‘ï¸ Delete Old Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7       # ä¿ç•™7å¤©çš„è¿è¡Œè®°å½•
          keep_minimum_runs: 10 # è‡³å°‘ä¿ç•™10æ¬¡è¿è¡Œè®°å½•
